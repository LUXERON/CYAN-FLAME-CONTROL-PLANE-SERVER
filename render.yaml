# ═══════════════════════════════════════════════════════════════════════════════
#   VXLAN CONTROL PLANE SERVER - RENDER DEPLOYMENT
#   NEUNOMY - NULL SPACE AI INFERENCE NETWORK
# ═══════════════════════════════════════════════════════════════════════════════
#
# Mathematical Acceleration for Hyperscaler Infrastructure
# STATIC LINKING DEPLOYMENT (Single Binary, No Container)
#
# CAPABILITIES:
# • 166,420× Memory Amplification (QAGML Tier 4)
# • 1,000,000× Bandwidth Amplification (QANBAN)
# • 250× Compression (UAO-QTCAM)
# • 250× Cache Compression (UAO-QTCAM Cache - NO REDIS NEEDED!)
#
# ESTIMATED COST: $85/month (Pro Plus plan)
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ═══════════════════════════════════════════════════════════════════════════
  # CYAN FLAME CONTROL PLANE SERVER (STATIC BINARY)
  # ═══════════════════════════════════════════════════════════════════════════
  - type: web
    name: cyan-flame-control-plane
    runtime: rust
    plan: pro_plus  # $85/month - 4 GB RAM, 2 CPUs
    region: oregon
    branch: main
    # rootDir not needed - files are at repo root

    # Build configuration - Uses pre-generated proto files (no protoc needed)
    buildCommand: cargo build --release --bin cyan-flame-unified

    # Start command - Unified Server binary with PRODUCTION SECURITY
    # --auth: Enable API key authentication (required for all requests)
    # Note: TLS is handled by Render's edge HTTPS for HTTP port
    # gRPC clients should use the HTTPS endpoint (Render terminates TLS)
    startCommand: ./target/release/cyan-flame-unified --auth

    # Health check endpoint
    healthCheckPath: /health

    # Environment variables
    envVars:
      # Server configuration - Render uses PORT env var
      - key: PORT
        value: 10000
      - key: HTTP_PORT
        value: 10000
      - key: HTTP_BIND
        value: 0.0.0.0

      # VXLAN over WebSocket (Render doesn't support raw UDP)
      # Agents connect via WebSocket, server bridges to internal VXLAN
      - key: VXLAN_MODE
        value: websocket
      - key: VXLAN_WS_PORT
        value: 10000

      # Cache configuration (256 MB = 64 GB effective with 250× compression)
      - key: CACHE_SIZE_MB
        value: 256

      # Maximum connections
      - key: MAX_CONNECTIONS
        value: 10000

      # Logging
      - key: RUST_LOG
        value: symmetrix=info,control_plane=info,tower_http=info
      - key: RUST_BACKTRACE
        value: "1"

      # ═══════════════════════════════════════════════════════════════════════
      # PRODUCTION API KEYS (sync=false means stored securely in Render)
      # ═══════════════════════════════════════════════════════════════════════
      # IMPORTANT: Set these in Render Dashboard > Environment
      # These are sync=false so they won't be in source control
      - key: CYAN_FLAME_ENTERPRISE_KEY
        sync: false  # Set in Render Dashboard for security
      - key: CYAN_FLAME_PRO_KEY
        sync: false  # Set in Render Dashboard for security

      # Amplification Tiers
      - key: QAGML_TIER
        value: "4"
      - key: QAGML_AMPLIFICATION
        value: "166420"
      - key: QANBAN_AMPLIFICATION
        value: "1000000"
      - key: UAO_COMPRESSION
        value: "250"

    # Auto-deploy on push
    autoDeploy: true

# ═══════════════════════════════════════════════════════════════════════════════
# ARCHITECTURE: WHY STATIC LINKING?
# ═══════════════════════════════════════════════════════════════════════════════
#
# The Control Plane is a COORDINATOR, not a compute engine:
#
# ┌─────────────────────────────────────────────────────────────────────────┐
# │  WHERE COMPUTE HAPPENS:                                                 │
# │  ❌ NOT the Control Plane (coordination only)                          │
# │  ✅ ON THE GPU NODES (CUDA interception library)                       │
# │  ✅ ON HYPERSCALER H100/H200 GPUs (actual tensor ops)                  │
# └─────────────────────────────────────────────────────────────────────────┘
#
# Control Plane responsibilities:
# • Track virtual memory allocations (state management)
# • Route VXLAN packets to correct VNI (routing table)
# • Apply QAGML/QANBAN/UAO-QTCAM transformations
# • Maintain tunnel state (single source of truth)
#
# WHY NO HORIZONTAL SCALING:
# • QANBAN: 1,000,000× bandwidth = fewer packets to process
# • UAO-QTCAM: 250× compression = less data
# • Stateful coordination requires consistency
# • ONE instance handles everything
#
# ═══════════════════════════════════════════════════════════════════════════════
# COST BREAKDOWN (NO REDIS NEEDED!)
# ═══════════════════════════════════════════════════════════════════════════════
#
# Traditional Stack:
# ├─ Web Server (Pro Plus):     $85/month
# ├─ Redis (Starter):           $10/month
# └─ Total:                     $95/month
#
# NEUNOMY Stack (UAO-QTCAM Cache):
# ├─ Web Server (Pro Plus):     $85/month
# ├─ Redis:                     $0/month (REPLACED BY UAO-QTCAM!)
# └─ Total:                     $85/month
#
# ═══════════════════════════════════════════════════════════════════════════════
# CAPACITY METRICS (Amplified)
# ═══════════════════════════════════════════════════════════════════════════════
#
# Physical Resources:
# ├─ RAM:      4 GB
# ├─ CPUs:     2 cores
# └─ Cache:    256 MB compressed
#
# Virtual/Amplified Resources:
# ├─ Memory:   4 GB → 665 TB (166,420× QAGML Tier 4)
# ├─ Bandwidth: Effectively unlimited (1M× QANBAN)
# ├─ Cache:    256 MB → 64 GB effective (250× UAO-QTCAM)
# └─ TCAM:     O(log n) lookups (1,250× speedup)
#
# ═══════════════════════════════════════════════════════════════════════════════
# HTTP ENDPOINTS
# ═══════════════════════════════════════════════════════════════════════════════
#
# Health & Status:
# ├─ GET  /health        - Health check (required by Render)
# ├─ GET  /              - Server info and ASCII banner
# ├─ GET  /stats         - Comprehensive statistics
# │
# # SYMMETRIX CORE Integration:
# ├─ GET  /cascade       - Cascade amplification stats
# ├─ GET  /memory        - QAGML memory stats (166,420× amplification)
# ├─ GET  /bandwidth     - QANBAN bandwidth stats (1M× amplification)
# ├─ GET  /cache/stats   - UAO-QTCAM cache stats (250× compression)
# │
# # VXLAN Control (WebSocket bridge):
# ├─ WS   /ws/vxlan      - WebSocket VXLAN tunnel endpoint
# ├─ POST /api/vxlan     - HTTP VXLAN command endpoint
# │
# # Kubernetes Integration:
# ├─ GET  /api/pools     - List virtual GPU pools
# ├─ GET  /api/claims    - List virtual GPU claims
# └─ GET  /api/tiers     - List customer tiers
#
# ═══════════════════════════════════════════════════════════════════════════════
# DEPLOYMENT URLS
# ═══════════════════════════════════════════════════════════════════════════════
#
# After deployment:
# • Health: https://cyan-flame-control-plane.onrender.com/health
# • Stats:  https://cyan-flame-control-plane.onrender.com/stats
# • VXLAN:  wss://cyan-flame-control-plane.onrender.com/ws/vxlan
# • gRPC:   grpc://cyan-flame-control-plane.onrender.com:443
#
# ═══════════════════════════════════════════════════════════════════════════════

